<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Aura Social - Intelligent Social Platform{% endblock %}</title>
    
    <!-- Global Styles -->
    <style>
        :root {
            --primary: #2A2D7A;
            --accent: #00F5A0;
            --background: #0F0F1A;
            --surface: #1E1E2E;
            --text: #E2E2E8;
            --text-muted: #8B8B9E;
            --danger: #ff6b6b;
            --warning: #ffd93d;
            --success: #6bcf7f;
            --info: #4dabf7;
            --online: #00F5A0;
            --offline: #8B8B9E;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--background);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Header Styles */
        .global-header {
            background: var(--surface);
            border-bottom: 2px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none;
        }
        
        .nav-links {
            display: flex;
            align-items: center;
            gap: 2rem;
            list-style: none;
        }
        
        .nav-link {
            color: var(--text-muted);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--accent);
            background: rgba(0, 245, 160, 0.1);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: #000;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
        }
        
        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--online);
            border: 2px solid var(--surface);
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--accent);
            color: #000;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 245, 160, 0.3);
        }
        
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--text-muted);
            color: var(--text-muted);
        }
        
        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        /* Main Content */
        .main-content {
            min-height: calc(100vh - 70px);
            padding: 2rem 1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .container-sm {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .container-md {
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* Card Styles */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #2A2D7A33;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #2A2D7A33;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .card-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            background: rgba(42, 45, 122, 0.3);
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 1rem;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 245, 160, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }
        
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }
        
        .p-1 { padding: 0.5rem; }
        .p-2 { padding: 1rem; }
        .p-3 { padding: 1.5rem; }
        .p-4 { padding: 2rem; }
        
        .d-flex { display: flex; }
        .d-none { display: none; }
        .flex-column { flex-direction: column; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .gap-3 { gap: 1.5rem; }
        .gap-4 { gap: 2rem; }
        
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
        
        /* Status Badges */
        .badge {
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-primary { background: var(--primary); color: white; }
        .badge-accent { background: var(--accent); color: #000; }
        .badge-success { background: var(--success); color: white; }
        .badge-warning { background: var(--warning); color: #000; }
        .badge-danger { background: var(--danger); color: white; }
        .badge-info { background: var(--info); color: white; }
        
        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .spinner {
            border: 2px solid var(--text-muted);
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header-nav {
                flex-direction: column;
                height: auto;
                padding: 1rem 0;
                gap: 1rem;
            }
            
            .nav-links {
                gap: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .user-menu {
                gap: 0.5rem;
            }
            
            .main-content {
                padding: 1rem 0.5rem;
            }
            
            .container, .container-sm, .container-md {
                padding: 0 0.5rem;
            }
        }
        
        /* Notification System */
        .notification {
            position: fixed;
            top: 90px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            background: var(--surface);
            border: 1px solid var(--primary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            border-color: var(--success);
            background: rgba(107, 207, 127, 0.1);
        }
        
        .notification.error {
            border-color: var(--danger);
            background: rgba(255, 107, 107, 0.1);
        }
        
        .notification.warning {
            border-color: var(--warning);
            background: rgba(255, 217, 61, 0.1);
        }
        
        .notification.info {
            border-color: var(--info);
            background: rgba(77, 171, 247, 0.1);
        }
        
        .notification-icon {
            font-size: 1.2rem;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Notifications Panel */
        .notifications-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 400px;
            max-width: 90vw;
            background: var(--surface);
            border: 1px solid var(--primary);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            transform: translateY(-20px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .notifications-panel.show {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        
        .notifications-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #2A2D7A33;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .notifications-title {
            font-weight: 600;
            color: var(--text);
        }
        
        .notifications-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #2A2D7A33;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .notification-item:hover {
            background: rgba(42, 45, 122, 0.1);
        }
        
        .notification-item.unread {
            background: rgba(0, 245, 160, 0.05);
        }
        
        .notification-message {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .notification-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        .no-notifications {
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
        }
    </style>
    
    <!-- Page-specific styles -->
    {% block styles %}{% endblock %}
    
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <!-- Global Header -->
    {% block header %}
    <header class="global-header">
        <div class="header-container">
            <nav class="header-nav">
                <a href="{% if current_user %}/{% else %}/{% endif %}" class="logo">AURA</a>
                
                {% if current_user %}
                <ul class="nav-links">
                    <li><a href="/" class="nav-link {% if request.path == '/' %}active{% endif %}">Feed</a></li>
                    <li><a href="/messages" class="nav-link {% if request.path == '/messages' %}active{% endif %}">
                        Messages
                        <span class="notification-badge" id="messagesBadge" style="display: none;">0</span>
                    </a></li>
                    <li><a href="/my_profile" class="nav-link {% if request.path == '/my_profile' %}active{% endif %}">Profile</a></li>
                    {% if current_user.role == 'admin' %}
                    <li><a href="/admin" class="nav-link {% if request.path.startswith('/admin') %}active{% endif %}">Admin</a></li>
                    {% endif %}
                </ul>
                
                <div class="user-menu">
                    <div class="user-avatar" id="notificationsIcon" onclick="toggleNotifications()" style="cursor: pointer;">
                        {{ current_user.avatar }}
                        <span class="notification-badge" id="notificationsBadge" style="display: none;">0</span>
                        <div class="online-indicator"></div>
                    </div>
                    <span class="nav-link">{{ current_user.display_name }}</span>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                </div>
                {% else %}
                <div class="user-menu">
                    <a href="/" class="btn btn-primary">Get Started</a>
                </div>
                {% endif %}
            </nav>
        </div>
    </header>
    {% endblock %}
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="btn btn-secondary btn-sm" onclick="markAllAsRead()">Mark all read</button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <div class="no-notifications">No new notifications</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Global Scripts -->
    <script>
        let socket = null;
        let notifications = [];
        
        // Initialize global functionality
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            loadNotifications();
        });
        
        function initializeSocket() {
            if (typeof io !== 'undefined') {
                socket = io();
                
                socket.on('connect', () => {
                    console.log('Connected to notifications');
                });
                
                socket.on('new_notification', (data) => {
                    addNotification(data);
                    showNotification(data.message, 'info');
                    updateNotificationBadges();
                });
                
                socket.on('new_message', (data) => {
                    if (window.location.pathname !== '/messages') {
                        showNotification(`New message from ${data.sender.display_name}`, 'info');
                        updateMessagesBadge();
                    }
                });
            }
        }
        
        function loadNotifications() {
            // Simulate loading notifications
            setTimeout(() => {
                notifications = [
                    {
                        id: 1,
                        type: 'like',
                        message: 'John liked your post',
                        timestamp: new Date(),
                        read: false,
                        link: '/'
                    },
                    {
                        id: 2,
                        type: 'comment',
                        message: 'Sarah commented on your photo',
                        timestamp: new Date(Date.now() - 300000),
                        read: false,
                        link: '/'
                    },
                    {
                        id: 3,
                        type: 'follow',
                        message: 'Mike started following you',
                        timestamp: new Date(Date.now() - 3600000),
                        read: true,
                        link: '/profile/mike'
                    }
                ];
                updateNotificationsDisplay();
            }, 1000);
        }
        
        function addNotification(notification) {
            notifications.unshift({
                ...notification,
                id: Date.now(),
                timestamp: new Date(),
                read: false
            });
            updateNotificationsDisplay();
        }
        
        function updateNotificationsDisplay() {
            const list = document.getElementById('notificationsList');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (notifications.length === 0) {
                list.innerHTML = '<div class="no-notifications">No new notifications</div>';
            } else {
                list.innerHTML = notifications.map(notification => `
                    <div class="notification-item ${notification.read ? '' : 'unread'}" onclick="handleNotificationClick(${notification.id})">
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${formatTime(notification.timestamp)}</div>
                    </div>
                `).join('');
            }
            
            updateNotificationBadges();
        }
        
        function updateNotificationBadges() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationsBadge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function updateMessagesBadge() {
            const badge = document.getElementById('messagesBadge');
            // Simulate unread messages count
            const unreadCount = Math.floor(Math.random() * 5) + 1;
            if (unreadCount > 0 && window.location.pathname !== '/messages') {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            }
        }
        
        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('show');
        }
        
        function handleNotificationClick(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification && !notification.read) {
                notification.read = true;
                updateNotificationsDisplay();
            }
            toggleNotifications();
        }
        
        function markAllAsRead() {
            notifications.forEach(notification => {
                notification.read = true;
            });
            updateNotificationsDisplay();
        }
        
        // Global utility functions
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">${getNotificationIcon(type)}</div>
                <div class="notification-content">${message}</div>
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, duration);
        }
        
        function getNotificationIcon(type) {
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: '💡'
            };
            return icons[type] || '💡';
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return date.toLocaleDateString();
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Auth check and redirect
        async function checkAuth() {
            try {
                const response = await fetch('/api/current_user');
                const result = await response.json();
                return result.success ? result.user : null;
            } catch (error) {
                console.error('Auth check failed:', error);
                return null;
            }
        }
        
        // Logout function
        async function logout() {
            try {
                await fetch('/api/logout');
                window.location.href = '/';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }
        
        // Close notifications when clicking outside
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('notificationsPanel');
            const icon = document.getElementById('notificationsIcon');
            if (panel.classList.contains('show') && !panel.contains(e.target) && !icon.contains(e.target)) {
                panel.classList.remove('show');
            }
        });
    </script>
    
    <!-- Page-specific scripts -->
    {% block scripts %}{% endblock %}
</body>
</html>
